<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>EXIF Frame</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 20px;
			display: flex;
			flex-direction: column;
			/* 全体を縦並びに */
			align-items: center;
			box-sizing: border-box;
		}

		.file-input-container {
			margin-bottom: 20px;
			/* ファイル選択と他要素の間隔 */
		}

		.container {
			display: flex;
			justify-content: center;
			/* 中央揃え */
			gap: 20px;
			/* canvasとcontrolsの間のスペース */
			width: 100%;
			/* 横幅をコンテナ内で調整 */
			max-width: 1200px;
			/* コンテナの最大幅を設定 */
		}

		canvas {
			border: 1px solid #ccc;
			max-width: 600px;
			/* 横幅を適切に制限 */
			max-height: 400px;
			/* 横幅を適切に制限 */
			height: auto;
			/* 縦横比を維持 */
		}

		.controls {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.exif-controls label {
			display: flex;
			align-items: center;
			font-size: 16px;
		}

		.exif-controls2 label {
			display: flex;
			align-items: center;
			font-size: 16px;
		}

		.expand-controls label {
			margin-left: -1px;
		}

		.exif-controls input[type="text"] {
			margin-left: 10px;
			width: 200px;
			font-size: 14px;
			padding: 5px;
		}

		#camera-brand {
			margin-left: 10px;
			width: 200px;
			font-size: 14px;
			padding: 5px;
		}

		.exif-controls input[type="checkbox"] {
			margin-right: 10px;
		}

		.buttons {
			display: flex;
			gap: 10px;
		}

		.buttons button {
			padding: 5px 10px;
			font-size: 14px;
			cursor: pointer;
		}

		.expand-controls input[type="number"] {
			margin-left: 1px;
			width: 60px;
			font-size: 14px;
			padding: 5px;
		}

		/* スマートフォン用のスタイル */
		@media (max-width: 768px) {
			.container {
				flex-direction: column;
				align-items: center;
				/* 中央揃え */
				width: 100%;
			}

			.canvas-wrapper {
				width: 100%;
				max-width: 100%;
				overflow: auto;
				/* スクロール可能に設定 */
				display: flex;
				justify-content: center;
				/* canvasを中央揃え */
			}

			canvas {
				max-width: 100%;
				/* 横幅を画面いっぱいに収める */
				max-height: none;
				/* 高さの制限を解除 */
				width: auto;
				/* 縦横比を維持して横幅に合わせる */
				height: auto;
				/* 縦横比を維持して高さを調整 */
			}

			.controls {
				width: 100%;
				margin-top: 20px;
				display: flex;
				flex-direction: column;
				/* コントロール項目を縦に並べる */
				align-items: stretch;
			}

		}
	</style>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
	<h1>EXIF Frame</h1>
	<div class="file-input-container">
		<input type="file" id="imageInput" accept="image/*">

		<label for="resize">resize (px):</label>
		<input type="number" id="resize" value="3840">
	</div>
	<div class="container">
		<canvas id="canvas"></canvas>
		<div class="controls">
			<div class="exif-controls">
				<label><input type="checkbox" id="cameraNameCheck" checked>Camera Name:</label>
				<input type="text" id="cameraName" value="N/A">
				<label><input type="checkbox" id="lensCheck" checked>Lens:</label>
				<input type="text" id="lens" value="N/A">
				<label><input type="checkbox" id="isoCheck" checked>ISO:</label>
				<input type="text" id="iso" value="N/A">
				<label><input type="checkbox" id="shutterSpeedCheck" checked>Shutter Speed:</label>
				<input type="text" id="shutterSpeed" value="N/A">
				<label><input type="checkbox" id="apertureCheck" checked>Aperture:</label>
				<input type="text" id="aperture" value="N/A">
				<label><input type="checkbox" id="focalLengthCheck" checked>Focal Length:</label>
				<input type="text" id="focalLength" value="N/A">
				<label><input type="checkbox" id="brandCheck" checked>Brand:</label>
				<select id="camera-brand" name="camera-brand">
					<option value="null">(None)</option>
					<option value="Canon">Canon</option>
					<option value="Nikon">Nikon</option>
					<option value="SONY">Sony</option>
					<option value="SONY[White]">Sony[White]</option>
				</select>
			</div>
			<div class="exif-controls2">
				<label for="color0">Color 0:</label>
				<input type="text" id="color0" value="#000000">
				<label for="color1">Color 1:</label>
				<input type="text" id="color1" value="#FFFFFF">
				<label for="color2">Color 2:</label>
				<input type="text" id="color2" value="#444444">
			</div>
			<div class="expand-controls">
				<label for="expandAll">ExpandAllSides (px):</label>
				<input type="number" id="expandAll" value="200">
				<label for="expandUp">Expand up:</label>
				<input type="number" id="expandUp" value="200">
				<label for="expandDown">Expand down:</label>
				<input type="number" id="expandDown" value="750">
			</div>
		</div>
	</div>
	<div class="buttons">
		<button id="updateTextButton">Update Text</button>
		<button id="downloadButton">Download</button>
	</div>

	<script>
		const imageInput = document.getElementById('imageInput');
		const canvas = document.getElementById('canvas');
		const ctx = canvas.getContext('2d');
		const downloadButton = document.getElementById('downloadButton');
		const updateTextButton = document.getElementById('updateTextButton');

		const cameraName = document.getElementById('cameraName');
		const iso = document.getElementById('iso');
		const shutterSpeed = document.getElementById('shutterSpeed');
		const aperture = document.getElementById('aperture');
		const focalLength = document.getElementById('focalLength');
		const lens = document.getElementById('lens');
		const brand = document.getElementById('camera-brand');

		const cameraNameCheck = document.getElementById('cameraNameCheck');
		const lensCheck = document.getElementById('lensCheck');
		const isoCheck = document.getElementById('isoCheck');
		const shutterSpeedCheck = document.getElementById('shutterSpeedCheck');
		const apertureCheck = document.getElementById('apertureCheck');
		const focalLengthCheck = document.getElementById('focalLengthCheck');
		const brandCheck = document.getElementById('brandCheck');

		const expandAllInput = document.getElementById('expandAll');
		const expandUpInput = document.getElementById('expandUp');
		const expandDownInput = document.getElementById('expandDown');
		const resize = document.getElementById('resize');

		let currentImage = null;
		let fileName = "frame";
		let ratio = 1;

		imageInput.addEventListener('change', async (event) => {
			const file = event.target.files[0];
			fileName = file.name;
			if (file) {
				const img = new Image();
				img.onload = async () => {
					let maxWidth; // リサイズする横幅を設定
					if (img.height > img.width) {
						maxWidth = resize.value / 3 * 2; // 縦が横より大きい場合は横を4000pxに
					} else {
						maxWidth = resize.value; // それ以外は横を6000pxに
					}
					ratio = maxWidth / 6000;

					// 元画像の比率を計算してリサイズ
					const scale = maxWidth / img.width; // 横幅に基づく拡大縮小率
					const newWidth = maxWidth;
					const newHeight = img.height * scale; // 縦幅を比率に基づいて計算

					// Canvasにリサイズ画像を描画
					canvas.width = newWidth;
					canvas.height = newHeight;
					ctx.drawImage(img, 0, 0, newWidth, newHeight);

					// リサイズ後の画像を保持
					const resizedImg = new Image();
					resizedImg.src = canvas.toDataURL(); // CanvasからデータURLを生成してImageにセット
					currentImage = resizedImg;

					await extractExifData(file); // Exif情報の取得
					drawTextOverlay(); // Exif情報を取得後にオーバーレイを描画
				};
				img.src = URL.createObjectURL(file);

				// 再選択可能にする
				event.target.value = '';
			}
		});


		async function extractExifData(file) {
			const exifData = await readExifData(file);
			if (exifData) {
				if (cameraNameCheck.checked) cameraName.value = exifData.camera || 'N/A';
				if (lensCheck.checked) lens.value = exifData.lens || 'N/A';
				if (isoCheck.checked) iso.value = exifData.iso || 'N/A';
				if (shutterSpeedCheck.checked) shutterSpeed.value = exifData.shutterSpeed || 'N/A';
				if (apertureCheck.checked) aperture.value = exifData.aperture || 'N/A';
				if (focalLengthCheck.checked) focalLength.value = exifData.focalLength || 'N/A';
				if (brandCheck.checked) brand.value = exifData.brand || 'null';
			}
		}

		async function drawTextOverlay() {
    if (!canvas.width || !canvas.height || !currentImage) return;

    const color0Input = document.getElementById('color0');
    const color1Input = document.getElementById('color1');
    const color2Input = document.getElementById('color2');

    const expandAll = parseInt(expandAllInput.value * ratio, 10);
    const expandUp = parseInt(expandUpInput.value * ratio, 10);
    const expandDown = parseInt(expandDownInput.value * ratio, 10);

    const expandColor1 = color0Input.value || "#000000";
    canvas.width = currentImage.width + 2 * expandAll;
    canvas.height = currentImage.height + expandUp + expandDown;

    ctx.fillStyle = expandColor1;
    ctx.fillRect(0, 0, expandAll, canvas.height);
    ctx.fillRect(canvas.width - expandAll, 0, expandAll, canvas.height);
    ctx.fillRect(0, 0, canvas.width, expandUp);
    ctx.fillRect(0, canvas.height - expandDown, canvas.width, expandDown);

    const offsetX = expandAll;
    const offsetY = expandUp;
    ctx.drawImage(currentImage, offsetX, offsetY);

    const color1 = color1Input.value || "#FFFFFF";
    const color2 = color2Input.value || "#444444";
    const leftBottomText = `${cameraName.value}`;
    const leftBottomText2 = `${lens.value}`;
    ctx.font = 500 * ratio + " " + 150 * ratio + "px Inter";
    ctx.fillStyle = color1;
    ctx.strokeStyle = color1;
    ctx.lineWidth = 3 * ratio;
    ctx.strokeText(leftBottomText, expandAll + 50 * ratio, canvas.height + 300 * ratio - expandDown);
    ctx.fillText(leftBottomText, expandAll + 50 * ratio, canvas.height + 300 * ratio - expandDown);

    ctx.font = 100 * ratio + "px Inter";
    ctx.fillStyle = color2;
    ctx.fillText(leftBottomText2, expandAll + 50 * ratio, canvas.height + 450 * ratio - expandDown);

    const rightBottomText = [
        `${aperture.value}`,
        `${shutterSpeed.value}`,
        `${iso.value}`
    ].join(' ');

    const rightBottomText2 = `${focalLength.value}`;
    ctx.font = 500 * ratio + " " + 150 * ratio + "px Inter";
    const rightTextX = canvas.width - ctx.measureText(rightBottomText).width - expandAll;

    ctx.fillStyle = color1;
    ctx.strokeText(rightBottomText, rightTextX - 50 * ratio, canvas.height + 300 * ratio - expandDown);
    ctx.fillText(rightBottomText, rightTextX - 50 * ratio, canvas.height + 300 * ratio - expandDown);

    ctx.fillStyle = color2;
    ctx.font = 100 * ratio + "px Inter";
    ctx.fillText(rightBottomText2, rightTextX - 50 * ratio, canvas.height + 450 * ratio - expandDown);

    if (brand.value == "null") return;

    // SVG画像をロード
    const svgList = {
        "Canon": loadLocalSVG("canon-logo.svg"),
        "Nikon": loadLocalSVG("nikon-logo.svg"),
        "SONY": loadLocalSVG("sony-logo.svg"),
		"SONY[White]": loadLocalSVG("sony-white.svg")
    };

	const svgRatio = {
        "Canon": [1000,200],
        "Nikon": [1250,1250],
        "SONY": [1000,200],
		"SONY[White]": [1000,200]
    };

    // 画像の読み込みを待つ
    const svgImages = await Promise.all(Object.values(svgList));
    const selectedSvgImage = svgImages[Object.keys(svgList).indexOf(brand.value)];

    // SVGをキャンバスに描画
    const svgX = canvas.width / 2 - 400 * ratio;
    const svgY = canvas.height - 550 * ratio;
    const svgWidth = svgRatio[brand.value][0] * ratio;
    const svgHeight = svgRatio[brand.value][1] * ratio;
    ctx.drawImage(selectedSvgImage, svgX, svgY, svgWidth, svgHeight);
}

updateTextButton.addEventListener('click', drawTextOverlay);

downloadButton.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = "f" + fileName;
    link.href = canvas.toDataURL();
    link.click();
});

// ローカルのSVGを読み込む関数
async function loadLocalSVG(filePath) {
    const response = await fetch(filePath);
    const svgText = await response.text();
    return loadSVGToImage(svgText);
}

// SVGを画像に変換する関数
function loadSVGToImage(svgString) {
    return new Promise((resolve) => {
        const img = new Image();
        const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);
        img.onload = () => {
            URL.revokeObjectURL(url);
            resolve(img);
        };
        img.src = url;
    });
}


		async function readExifData(file) {
			return new Promise((resolve, reject) => {
				if (!window.EXIF) {
					console.error('EXIF library is not loaded.');
					resolve(null);
				} else {
					try {
						EXIF.Tags[0xA434] = "LensModel";
						EXIF.getData(file, function () {
							const allMetaData = EXIF.getAllTags(this);
							if (allMetaData.ExposureTime) {
								if (allMetaData.ExposureTime > 0.3) {
									var ss = `${allMetaData.ExposureTime}s`;
								} else {
									var ss = `1/${1 / allMetaData.ExposureTime}s`;
								}
							} else {
								var ss = null;
							}
							resolve({
								camera: allMetaData.Model ? `${allMetaData.Model}` : null,
								lens: EXIF.getTag(this, "LensModel") || null,
								iso: "ISO-" + allMetaData.ISOSpeedRatings || null,
								shutterSpeed: ss,
								aperture: allMetaData.FNumber ? `f/${allMetaData.FNumber}` : null,
								focalLength: allMetaData.FocalLength ? `${allMetaData.FocalLength}mm` : null,
								brand: allMetaData.Make ? allMetaData.Make : null
							});
						});
					} catch (error) {
						console.error('Error reading EXIF data:', error);
						resolve(null);
					}
				}
			});
		}

		// 説明メッセージを初期状態で非表示に設定（要素がない場合、再作成可）
		if (!document.getElementById('exifLibraryInfo')) {
			const exifLibraryInfo = document.createElement('p');
			exifLibraryInfo.id = 'exifLibraryInfo';
			exifLibraryInfo.style.fontSize = '12px';
			exifLibraryInfo.style.color = '#555';
			exifLibraryInfo.textContent = '';
			document.body.appendChild(exifLibraryInfo);
		}
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>
</body>

</html>
